<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#fef3c7">
  <title>Schulweg-Check</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      min-height: 100vh;
    }
    header {
      background: #f59e0b;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    main { padding: 16px; max-width: 500px; margin: 0 auto; }
    
    .big-btn {
      width: 100%;
      padding: 20px;
      border: none;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      -webkit-tap-highlight-color: transparent;
    }
    .big-btn:active { transform: scale(0.98); }
    .btn-danger { background: #fee2e2; color: #dc2626; border: 3px solid #fca5a5; }
    .btn-good { background: #d1fae5; color: #059669; border: 3px solid #6ee7b7; }
    .btn-list { background: #e0e7ff; color: #4338ca; border: 3px solid #a5b4fc; }
    .btn-admin { background: #f3e8ff; color: #7c3aed; border: 3px solid #c4b5fd; }
    .btn-qr { background: #fef3c7; color: #b45309; border: 3px solid #fcd34d; }
    
    .emoji { font-size: 32px; }
    
    .setup-box {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid #e5e7eb;
    }
    .setup-box label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #78350f;
    }
    .setup-box input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .setup-box input:focus { outline: none; border-color: #f59e0b; }
    .setup-saved { color: #059669; font-size: 14px; text-align: center; }
    
    .categories { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
    .cat-btn {
      padding: 16px 8px;
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      -webkit-tap-highlight-color: transparent;
    }
    .cat-btn:active { transform: scale(0.95); }
    .cat-btn.selected { border-color: #f59e0b; background: #fffbeb; }
    .cat-btn .emoji { display: block; font-size: 28px; margin-bottom: 4px; }
    
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #92400e;
      margin: 20px 0 12px 0;
      text-align: center;
    }
    
    .gps-box {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      text-align: center;
      border: 2px solid #e5e7eb;
    }
    .gps-ok { background: #d1fae5; border-color: #6ee7b7; color: #065f46; }
    .gps-waiting { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    .gps-error { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
    
    input[type="text"] {
      width: 100%;
      padding: 14px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      margin-bottom: 12px;
    }
    input:focus { outline: none; border-color: #f59e0b; }
    
    .save-btn {
      width: 100%;
      padding: 18px;
      background: #f59e0b;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      -webkit-tap-highlight-color: transparent;
    }
    .save-btn:disabled { background: #d1d5db; }
    .save-btn:active:not(:disabled) { transform: scale(0.98); }
    
    .back-btn {
      background: none;
      border: none;
      color: #b45309;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    .export-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 10px;
      -webkit-tap-highlight-color: transparent;
    }
    .export-geo { background: #7c3aed; color: white; }
    .export-csv { background: #2563eb; color: white; }
    .export-qml { background: #059669; color: white; }
    .delete-all { background: #fee2e2; color: #dc2626; }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-left: 5px solid;
    }
    .card-danger { border-color: #ef4444; }
    .card-good { border-color: #22c55e; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card-type { font-size: 24px; }
    .card-delete { background: none; border: none; color: #9ca3af; font-size: 20px; cursor: pointer; padding: 8px; }
    .card-category { font-weight: bold; font-size: 16px; margin-top: 4px; }
    .card-note { color: #6b7280; font-style: italic; margin-top: 4px; }
    .card-meta { color: #9ca3af; font-size: 12px; margin-top: 6px; }
    
    .empty { text-align: center; padding: 40px; color: #9ca3af; }
    .empty .emoji { font-size: 48px; }
    
    .hidden { display: none !important; }
    
    .count-badge {
      background: #4338ca;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 16px;
      margin-left: 8px;
    }

    .admin-section {
      background: white;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .admin-section h3 {
      color: #7c3aed;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-section p {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .stats-box {
      background: #f3f4f6;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .stats-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .stats-row:last-child { border-bottom: none; }

    /* QR Code Styles */
    .qr-container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
    }
    .qr-container canvas {
      max-width: 100%;
      height: auto;
    }
    .qr-name {
      font-size: 18px;
      font-weight: bold;
      color: #78350f;
      margin-top: 12px;
    }
    .qr-count {
      color: #6b7280;
      font-size: 14px;
    }

    /* Scanner Styles */
    .scanner-container {
      background: black;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
      position: relative;
    }
    .scanner-container video {
      width: 100%;
      display: block;
    }
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 3px solid #f59e0b;
      border-radius: 16px;
    }
    .scan-status {
      text-align: center;
      padding: 12px;
      font-weight: bold;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .scan-success { background: #d1fae5; color: #065f46; }
    .scan-waiting { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>
  <header>üö∏ Schulweg-Check</header>
  
  <main>
    <!-- Startseite -->
    <div id="homeView">
      <div class="setup-box">
        <label>üë§ Dein Name</label>
        <input type="text" id="childName" placeholder="z.B. Max">
        <label>üè´ Deine Klasse</label>
        <input type="text" id="childClass" placeholder="z.B. 3b">
        <div class="setup-saved" id="setupSaved"></div>
      </div>
      
      <p style="text-align:center; margin: 12px 0 16px 0; font-size: 18px; color: #78350f;">
        Wie ist dein Schulweg heute?
      </p>
      
      <button class="big-btn btn-danger" id="btnDanger">
        <span class="emoji">‚ö†Ô∏è</span> Hier ist's bl√∂d!
      </button>
      
      <button class="big-btn btn-good" id="btnGood">
        <span class="emoji">üëç</span> Hier ist's gut!
      </button>
      
      <button class="big-btn btn-list" id="btnList">
        <span class="emoji">üìã</span> Meine Meldungen <span class="count-badge" id="count">0</span>
      </button>

      <button class="big-btn btn-qr" id="btnShowQR">
        <span class="emoji">üì±</span> QR-Code zeigen
      </button>
      
      <button class="big-btn btn-admin" id="btnAdmin">
        <span class="emoji">üë®‚Äçüè´</span> Lehrer-Bereich
      </button>
    </div>

    <!-- Meldung erstellen -->
    <div id="reportView" class="hidden">
      <button class="back-btn" id="backFromReport">‚Üê Zur√ºck</button>
      
      <div id="dangerCategories">
        <div class="section-title">Was ist hier das Problem?</div>
        <div class="categories" id="dangerCatList">
          <button class="cat-btn" data-cat="autos">
            <span class="emoji">üöó</span>Zu schnelle Autos
          </button>
          <button class="cat-btn" data-cat="gehweg">
            <span class="emoji">üö∂</span>Kein Gehweg
          </button>
          <button class="cat-btn" data-cat="querung">
            <span class="emoji">üö¶</span>Schwer zu √ºberqueren
          </button>
          <button class="cat-btn" data-cat="sicht">
            <span class="emoji">üëÄ</span>Schlecht zu sehen
          </button>
          <button class="cat-btn" data-cat="dunkel">
            <span class="emoji">üåô</span>Zu dunkel
          </button>
          <button class="cat-btn" data-cat="radfahrer">
            <span class="emoji">üö¥</span>Radfahrer gef√§hrlich
          </button>
          <button class="cat-btn" data-cat="baustelle">
            <span class="emoji">üöß</span>Baustelle
          </button>
          <button class="cat-btn" data-cat="sonstiges">
            <span class="emoji">‚ùì</span>Etwas anderes
          </button>
        </div>
      </div>

      <div id="goodCategories" class="hidden">
        <div class="section-title">Was ist hier gut?</div>
        <div class="categories" id="goodCatList">
          <button class="cat-btn" data-cat="ampel">
            <span class="emoji">üö¶</span>Gute Ampel
          </button>
          <button class="cat-btn" data-cat="zebrastreifen">
            <span class="emoji">ü¶ì</span>Zebrastreifen
          </button>
          <button class="cat-btn" data-cat="schuelerlotse">
            <span class="emoji">üßë‚Äçü¶∫</span>Sch√ºlerlotse
          </button>
          <button class="cat-btn" data-cat="breiter-gehweg">
            <span class="emoji">üõ£Ô∏è</span>Breiter Gehweg
          </button>
          <button class="cat-btn" data-cat="tempo30">
            <span class="emoji">üêå</span>Tempo 30
          </button>
          <button class="cat-btn" data-cat="gut-sonstiges">
            <span class="emoji">‚≠ê</span>Etwas anderes
          </button>
        </div>
      </div>

      <div class="section-title">üìç Dein Standort</div>
      <div class="gps-box gps-waiting" id="gpsBox">Tippe um deinen Standort zu speichern</div>
      <button class="big-btn" style="background:#3b82f6; color:white; border:none;" id="btnGPS">
        <span class="emoji">üìç</span> Standort speichern
      </button>

      <div class="section-title">‚úèÔ∏è M√∂chtest du noch was sagen?</div>
      <input type="text" id="note" placeholder="z.B. an der B√§ckerei...">

      <button class="save-btn" id="saveBtn" disabled>üíæ Speichern</button>
    </div>

    <!-- Liste -->
    <div id="listView" class="hidden">
      <button class="back-btn" id="backFromList">‚Üê Zur√ºck</button>
      <div id="exportBtns" class="hidden">
        <button class="big-btn btn-qr" id="btnShowQRFromList">
          <span class="emoji">üì±</span> QR-Code zeigen
        </button>
        <button class="export-btn delete-all" id="btnDeleteOwn">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <div id="reportList"></div>
    </div>

    <!-- QR Code Anzeige -->
    <div id="qrView" class="hidden">
      <button class="back-btn" id="backFromQR">‚Üê Zur√ºck</button>
      <div class="section-title">Zeige diesen Code deinem Lehrer</div>
      <div class="qr-container">
        <canvas id="qrCanvas"></canvas>
        <div class="qr-name" id="qrName"></div>
        <div class="qr-count" id="qrCount"></div>
      </div>
      <p style="text-align:center; color:#6b7280; font-size:14px;">
        Dein Lehrer scannt diesen Code und hat alle deine Meldungen.
      </p>
    </div>

    <!-- Admin -->
    <div id="adminView" class="hidden">
      <button class="back-btn" id="backFromAdmin">‚Üê Zur√ºck</button>
      
      <div class="admin-section">
        <h3>üì∑ QR-Codes scannen</h3>
        <p>Scanne die QR-Codes der Kinder um ihre Meldungen zu sammeln.</p>
        <button class="big-btn btn-qr" id="btnStartScan">
          <span class="emoji">üì∑</span> Scanner starten
        </button>
      </div>

      <div class="admin-section">
        <h3>üìä Statistik</h3>
        <div class="stats-box">
          <div class="stats-row"><span>Gesamte Meldungen:</span><strong id="statTotal">0</strong></div>
          <div class="stats-row"><span>‚ö†Ô∏è Gefahrenstellen:</span><strong id="statDanger">0</strong></div>
          <div class="stats-row"><span>üëç Gute Stellen:</span><strong id="statGood">0</strong></div>
          <div class="stats-row"><span>üë• Kinder:</span><strong id="statChildren">0</strong></div>
        </div>
        <div id="categoryStats"></div>
      </div>

      <div class="admin-section">
        <h3>üì§ Export f√ºr QGIS</h3>
        <button class="export-btn export-geo" id="btnExportAll">üì• Alle Meldungen (GeoJSON)</button>
        <button class="export-btn export-geo" style="background:#dc2626" id="btnExportDanger">üì• Nur Gefahrenstellen</button>
        <button class="export-btn export-geo" style="background:#059669" id="btnExportGood">üì• Nur gute Stellen</button>
        <button class="export-btn export-qml" id="btnExportQML">üé® QGIS-Stildatei</button>
        <button class="export-btn export-csv" id="btnExportCSV">üì• CSV f√ºr Excel</button>
      </div>

      <div class="admin-section">
        <h3>üóëÔ∏è Daten verwalten</h3>
        <button class="export-btn delete-all" id="btnDeleteAll">Alle gesammelten Daten l√∂schen</button>
      </div>
    </div>

    <!-- Scanner -->
    <div id="scanView" class="hidden">
      <button class="back-btn" id="backFromScan">‚Üê Zur√ºck</button>
      <div class="section-title">QR-Code scannen</div>
      <div class="scan-status scan-waiting" id="scanStatus">üì∑ Halte einen QR-Code vor die Kamera</div>
      <div class="scanner-container">
        <video id="scanVideo" playsinline></video>
        <div class="scanner-overlay"></div>
      </div>
      <canvas id="scanCanvas" style="display:none;"></canvas>
      <div id="scannedList"></div>
    </div>
  </main>

  <script>
    var reports = JSON.parse(localStorage.getItem('schulwegReports') || '[]');
    var allReports = JSON.parse(localStorage.getItem('schulwegAllReports') || '[]');
    var currentType = null;
    var selectedCat = null;
    var position = null;
    var scanning = false;
    var videoStream = null;
    
    document.getElementById('childName').value = localStorage.getItem('childName') || '';
    document.getElementById('childClass').value = localStorage.getItem('childClass') || '';
    
    updateCount();
    updateStats();

    // Event Listeners
    document.getElementById('childName').addEventListener('input', saveSetup);
    document.getElementById('childClass').addEventListener('input', saveSetup);
    document.getElementById('btnDanger').addEventListener('click', function() { startReport('danger'); });
    document.getElementById('btnGood').addEventListener('click', function() { startReport('good'); });
    document.getElementById('btnList').addEventListener('click', showList);
    document.getElementById('btnAdmin').addEventListener('click', showAdmin);
    document.getElementById('btnShowQR').addEventListener('click', showQR);
    document.getElementById('btnShowQRFromList').addEventListener('click', showQR);
    document.getElementById('backFromReport').addEventListener('click', showHome);
    document.getElementById('backFromList').addEventListener('click', showHome);
    document.getElementById('backFromAdmin').addEventListener('click', showHome);
    document.getElementById('backFromQR').addEventListener('click', showHome);
    document.getElementById('backFromScan').addEventListener('click', stopScanAndGoBack);
    document.getElementById('btnGPS').addEventListener('click', getGPS);
    document.getElementById('saveBtn').addEventListener('click', save);
    document.getElementById('btnDeleteOwn').addEventListener('click', deleteAll);
    document.getElementById('btnStartScan').addEventListener('click', startScan);
    document.getElementById('btnExportAll').addEventListener('click', exportAllGeoJSON);
    document.getElementById('btnExportDanger').addEventListener('click', exportDangerGeoJSON);
    document.getElementById('btnExportGood').addEventListener('click', exportGoodGeoJSON);
    document.getElementById('btnExportQML').addEventListener('click', exportQML);
    document.getElementById('btnExportCSV').addEventListener('click', exportAllCSV);
    document.getElementById('btnDeleteAll').addEventListener('click', deleteAllAdmin);

    document.querySelectorAll('.cat-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { selectCat(this); });
    });

    function saveSetup() {
      localStorage.setItem('childName', document.getElementById('childName').value.trim());
      localStorage.setItem('childClass', document.getElementById('childClass').value.trim());
      var n = document.getElementById('childName').value.trim();
      var c = document.getElementById('childClass').value.trim();
      document.getElementById('setupSaved').textContent = (n && c) ? '‚úì Gespeichert' : '';
    }

    function updateCount() {
      document.getElementById('count').textContent = reports.length;
    }

    function hideAllViews() {
      document.getElementById('homeView').classList.add('hidden');
      document.getElementById('reportView').classList.add('hidden');
      document.getElementById('listView').classList.add('hidden');
      document.getElementById('adminView').classList.add('hidden');
      document.getElementById('qrView').classList.add('hidden');
      document.getElementById('scanView').classList.add('hidden');
    }

    function showHome() {
      hideAllViews();
      document.getElementById('homeView').classList.remove('hidden');
      resetForm();
    }

    function resetForm() {
      currentType = null;
      selectedCat = null;
      position = null;
      document.querySelectorAll('.cat-btn').forEach(function(b) { b.classList.remove('selected'); });
      document.getElementById('note').value = '';
      document.getElementById('gpsBox').className = 'gps-box gps-waiting';
      document.getElementById('gpsBox').textContent = 'Tippe um deinen Standort zu speichern';
      document.getElementById('saveBtn').disabled = true;
    }

    function startReport(type) {
      var name = document.getElementById('childName').value.trim();
      var cls = document.getElementById('childClass').value.trim();
      if (!name || !cls) { alert('Bitte zuerst Name und Klasse eingeben!'); return; }
      currentType = type;
      hideAllViews();
      document.getElementById('reportView').classList.remove('hidden');
      document.getElementById('dangerCategories').classList.toggle('hidden', type !== 'danger');
      document.getElementById('goodCategories').classList.toggle('hidden', type !== 'good');
    }

    function selectCat(btn) {
      document.querySelectorAll('.cat-btn').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      selectedCat = btn.getAttribute('data-cat');
      checkSaveReady();
    }

    function getGPS() {
      var box = document.getElementById('gpsBox');
      box.className = 'gps-box gps-waiting';
      box.textContent = '‚è≥ Suche...';
      navigator.geolocation.getCurrentPosition(
        function(pos) {
          position = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
          box.className = 'gps-box gps-ok';
          box.textContent = '‚úì Position gespeichert! (¬±' + position.acc.toFixed(0) + 'm)';
          checkSaveReady();
        },
        function(err) {
          box.className = 'gps-box gps-error';
          box.textContent = '‚úó Fehler: ' + err.message;
        },
        { enableHighAccuracy: true, timeout: 15000 }
      );
    }

    function checkSaveReady() {
      document.getElementById('saveBtn').disabled = !(selectedCat && position);
    }

    var categoryLabels = {
      'autos': 'Zu schnelle Autos', 'gehweg': 'Kein Gehweg', 'querung': 'Schwer zu √ºberqueren',
      'sicht': 'Schlecht zu sehen', 'dunkel': 'Zu dunkel', 'radfahrer': 'Radfahrer gef√§hrlich',
      'baustelle': 'Baustelle', 'sonstiges': 'Sonstiges', 'ampel': 'Gute Ampel',
      'zebrastreifen': 'Zebrastreifen', 'schuelerlotse': 'Sch√ºlerlotse', 'breiter-gehweg': 'Breiter Gehweg',
      'tempo30': 'Tempo 30', 'gut-sonstiges': 'Sonstiges Gutes'
    };

    function save() {
      reports.unshift({
        id: Date.now(),
        timestamp: new Date().toISOString(),
        type: currentType,
        category: selectedCat,
        categoryLabel: categoryLabels[selectedCat] || selectedCat,
        note: document.getElementById('note').value.trim(),
        childName: document.getElementById('childName').value.trim(),
        childClass: document.getElementById('childClass').value.trim(),
        lat: position.lat, lng: position.lng, acc: position.acc
      });
      localStorage.setItem('schulwegReports', JSON.stringify(reports));
      updateCount();
      alert('‚úì Gespeichert!');
      showHome();
    }

    function showList() {
      hideAllViews();
      document.getElementById('listView').classList.remove('hidden');
      document.getElementById('exportBtns').classList.toggle('hidden', reports.length === 0);
      renderList();
    }

    function showAdmin() {
      hideAllViews();
      document.getElementById('adminView').classList.remove('hidden');
      updateStats();
    }

    function renderList() {
      var list = document.getElementById('reportList');
      if (reports.length === 0) {
        list.innerHTML = '<div class="empty"><span class="emoji">üì≠</span><br>Noch keine Meldungen</div>';
        return;
      }
      var html = '';
      for (var i = 0; i < reports.length; i++) {
        var r = reports[i];
        html += '<div class="card card-' + (r.type === 'danger' ? 'danger' : 'good') + '">' +
          '<div class="card-header"><span class="card-type">' + (r.type === 'danger' ? '‚ö†Ô∏è' : 'üëç') + '</span>' +
          '<button class="card-delete" data-id="' + r.id + '">‚úï</button></div>' +
          '<div class="card-category">' + r.categoryLabel + '</div>' +
          (r.note ? '<div class="card-note">"' + r.note + '"</div>' : '') +
          '<div class="card-meta">üìç ' + r.lat.toFixed(5) + ', ' + r.lng.toFixed(5) + '<br>üïê ' + new Date(r.timestamp).toLocaleString('de-DE') + '</div></div>';
      }
      list.innerHTML = html;
      list.querySelectorAll('.card-delete').forEach(function(btn) {
        btn.addEventListener('click', function() { deleteReport(parseInt(this.getAttribute('data-id'))); });
      });
    }

    function deleteReport(id) {
      if (!confirm('L√∂schen?')) return;
      reports = reports.filter(function(r) { return r.id !== id; });
      localStorage.setItem('schulwegReports', JSON.stringify(reports));
      updateCount();
      showList();
    }

    function deleteAll() {
      if (!confirm('Alle Meldungen l√∂schen?')) return;
      reports = [];
      localStorage.setItem('schulwegReports', '[]');
      updateCount();
      showList();
    }

    // QR Code anzeigen
    function showQR() {
      if (reports.length === 0) {
        alert('Du hast noch keine Meldungen!');
        return;
      }
      hideAllViews();
      document.getElementById('qrView').classList.remove('hidden');
      
      var name = document.getElementById('childName').value.trim();
      var cls = document.getElementById('childClass').value.trim();
      
      document.getElementById('qrName').textContent = name + ' (' + cls + ')';
      document.getElementById('qrCount').textContent = reports.length + ' Meldung' + (reports.length > 1 ? 'en' : '');
      
      // Kompakte Daten f√ºr QR
      var qrData = {
        n: name,
        c: cls,
        r: reports.map(function(r) {
          return {
            t: r.type === 'danger' ? 'd' : 'g',
            k: r.category,
            la: Math.round(r.lat * 100000) / 100000,
            lo: Math.round(r.lng * 100000) / 100000,
            no: r.note || '',
            ts: r.timestamp
          };
        })
      };
      
      var qrString = JSON.stringify(qrData);
      
      var canvas = document.getElementById('qrCanvas');
      QRCode.toCanvas(canvas, qrString, { 
        width: 280,
        margin: 2,
        errorCorrectionLevel: 'L'
      }, function(error) {
        if (error) {
          console.error(error);
          alert('QR-Code konnte nicht erstellt werden. Zu viele Daten?');
        }
      });
    }

    // Scanner
    function startScan() {
      hideAllViews();
      document.getElementById('scanView').classList.remove('hidden');
      document.getElementById('scanStatus').textContent = 'üì∑ Halte einen QR-Code vor die Kamera';
      document.getElementById('scanStatus').className = 'scan-status scan-waiting';
      
      var video = document.getElementById('scanVideo');
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      }).then(function(stream) {
        videoStream = stream;
        video.srcObject = stream;
        video.play();
        scanning = true;
        requestAnimationFrame(scanLoop);
      }).catch(function(err) {
        alert('Kamera konnte nicht gestartet werden: ' + err.message);
        showAdmin();
      });
    }

    function scanLoop() {
      if (!scanning) return;
      
      var video = document.getElementById('scanVideo');
      var canvas = document.getElementById('scanCanvas');
      var ctx = canvas.getContext('2d');
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
          try {
            var data = JSON.parse(code.data);
            if (data.n && data.r) {
              processScannedData(data);
              return;
            }
          } catch (e) {
            // Kein g√ºltiger QR-Code
          }
        }
      }
      
      requestAnimationFrame(scanLoop);
    }

    function processScannedData(data) {
      var imported = 0;
      var name = data.n;
      var cls = data.c;
      
      data.r.forEach(function(r) {
        var fullReport = {
          id: Date.now() + Math.random(),
          timestamp: r.ts,
          type: r.t === 'd' ? 'danger' : 'good',
          category: r.k,
          categoryLabel: categoryLabels[r.k] || r.k,
          note: r.no,
          childName: name,
          childClass: cls,
          lat: r.la,
          lng: r.lo,
          acc: 0
        };
        
        // Duplikate pr√ºfen
        var isDuplicate = allReports.some(function(existing) {
          return existing.timestamp === fullReport.timestamp && 
                 existing.childName === fullReport.childName;
        });
        
        if (!isDuplicate) {
          allReports.push(fullReport);
          imported++;
        }
      });
      
      localStorage.setItem('schulwegAllReports', JSON.stringify(allReports));
      
      var status = document.getElementById('scanStatus');
      status.className = 'scan-status scan-success';
      status.textContent = '‚úì ' + name + ': ' + imported + ' Meldung' + (imported !== 1 ? 'en' : '') + ' hinzugef√ºgt!';
      
      updateScannedList();
      
      // Nach kurzer Pause weiter scannen
      setTimeout(function() {
        if (scanning) {
          status.className = 'scan-status scan-waiting';
          status.textContent = 'üì∑ N√§chsten QR-Code scannen...';
          requestAnimationFrame(scanLoop);
        }
      }, 2000);
    }

    function updateScannedList() {
      var cs = {};
      allReports.forEach(function(r) { 
        var key = r.childName + ' (' + r.childClass + ')';
        cs[key] = (cs[key] || 0) + 1;
      });
      
      var html = '<div class="admin-section"><h3>‚úì Gescannt</h3>';
      Object.keys(cs).forEach(function(name) {
        html += '<div class="stats-row"><span>' + name + '</span><strong>' + cs[name] + '</strong></div>';
      });
      html += '</div>';
      
      document.getElementById('scannedList').innerHTML = html;
    }

    function stopScanAndGoBack() {
      scanning = false;
      if (videoStream) {
        videoStream.getTracks().forEach(function(track) { track.stop(); });
        videoStream = null;
      }
      showAdmin();
    }

    function updateStats() {
      var total = allReports.length;
      var danger = allReports.filter(function(r) { return r.type === 'danger'; }).length;
      var good = allReports.filter(function(r) { return r.type === 'good'; }).length;
      var cs = {}; allReports.forEach(function(r) { cs[r.childName + r.childClass] = 1; });
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statDanger').textContent = danger;
      document.getElementById('statGood').textContent = good;
      document.getElementById('statChildren').textContent = Object.keys(cs).length;
      
      var cc = {}; allReports.forEach(function(r) { cc[r.categoryLabel] = (cc[r.categoryLabel]||0) + 1; });
      var sorted = Object.keys(cc).map(function(k) { return [k, cc[k]]; }).sort(function(a,b) { return b[1]-a[1]; });
      var html = sorted.length ? '<div class="stats-box"><strong>H√§ufigste:</strong>' : '';
      for (var i = 0; i < Math.min(5, sorted.length); i++) {
        html += '<div class="stats-row"><span>' + sorted[i][0] + '</span><strong>' + sorted[i][1] + '</strong></div>';
      }
      document.getElementById('categoryStats').innerHTML = html ? html + '</div>' : '';
    }

    function createGeoJSON(data) {
      return { type: 'FeatureCollection', features: data.map(function(r) {
        return { type: 'Feature', geometry: { type: 'Point', coordinates: [r.lng, r.lat] },
          properties: { type: r.type, category: r.category, categoryLabel: r.categoryLabel, note: r.note,
            childName: r.childName, childClass: r.childClass, timestamp: r.timestamp, accuracy: r.acc }};
      })};
    }

    function exportAllGeoJSON() {
      if (!allReports.length) { alert('Keine Daten'); return; }
      download(JSON.stringify(createGeoJSON(allReports), null, 2), 'schulweg-alle.geojson', 'application/json');
    }
    function exportDangerGeoJSON() {
      var d = allReports.filter(function(r) { return r.type === 'danger'; });
      if (!d.length) { alert('Keine Gefahrenstellen'); return; }
      download(JSON.stringify(createGeoJSON(d), null, 2), 'schulweg-gefahren.geojson', 'application/json');
    }
    function exportGoodGeoJSON() {
      var d = allReports.filter(function(r) { return r.type === 'good'; });
      if (!d.length) { alert('Keine guten Stellen'); return; }
      download(JSON.stringify(createGeoJSON(d), null, 2), 'schulweg-gut.geojson', 'application/json');
    }
    function exportAllCSV() {
      if (!allReports.length) { alert('Keine Daten'); return; }
      var rows = ['Typ;Kategorie;Name;Klasse;Notiz;Lat;Lng;Zeit'];
      allReports.forEach(function(r) { rows.push([r.type,r.categoryLabel,r.childName,r.childClass,r.note,r.lat,r.lng,r.timestamp].join(';')); });
      download(rows.join('\n'), 'schulweg-alle.csv', 'text/csv;charset=utf-8');
    }
    function exportQML() {
      var qml = '<!DOCTYPE qgis PUBLIC "http://mrcc.com/qgis.dtd" "SYSTEM">\n<qgis version="3.28">\n<renderer-v2 type="categorizedSymbol" attr="type">\n<categories>\n<category symbol="0" value="danger" label="Gefahrenstelle"/>\n<category symbol="1" value="good" label="Gute Stelle"/>\n</categories>\n<symbols>\n<symbol type="marker" name="0"><layer class="SimpleMarker"><prop k="color" v="220,38,38,255"/><prop k="size" v="4"/></layer></symbol>\n<symbol type="marker" name="1"><layer class="SimpleMarker"><prop k="color" v="34,197,94,255"/><prop k="size" v="4"/></layer></symbol>\n</symbols>\n</renderer-v2>\n</qgis>';
      download(qml, 'schulweg-stil.qml', 'application/xml');
    }
    function deleteAllAdmin() {
      if (!confirm('Alle Daten l√∂schen?')) return;
      allReports = [];
      localStorage.setItem('schulwegAllReports', '[]');
      updateStats();
      document.getElementById('scannedList').innerHTML = '';
    }
    function download(content, filename, type) {
      var a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([content], {type: type}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
